<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat de la Communauté</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Chat de la Communauté</h2>

        <!-- Liste des commentaires -->
        <div id="comments" class="mb-4"></div>

        <!-- Formulaire pour ajouter un commentaire -->
        <form id="commentForm">
            <div class="form-group">
                <textarea class="form-control" id="commentContent" placeholder="Écrivez un commentaire..." rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Poster</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/dist/stomp.min.js"></script>
    <script>
        let stompClient = null;

        function connect() {
            const socket = new SockJS('/ws'); // Connexion au serveur WebSocket
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connecté : ' + frame);

                // S'abonner aux commentaires d'une communauté
                stompClient.subscribe('/topic/comments/' + communityId, function (message) {
                    const comment = JSON.parse(message.body);
                    displayComment(comment);
                });
            });
        }

        function sendComment() {
            const content = document.getElementById("commentContent").value;
            if (content.trim() === "") {
                alert("Le commentaire ne peut pas être vide.");
                return;
            }

            const comment = {
                content: content,
                user: { id: userId }, // Utilisateur connecté
                community: { id: communityId } // Communauté active
            };

            stompClient.send("/app/chat/" + communityId, {}, JSON.stringify(comment));
            document.getElementById("commentContent").value = ""; // Réinitialiser le champ
        }

        function displayComment(comment) {
            const commentsDiv = document.getElementById("comments");
            const commentHTML = `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">${comment.user.name}</h5>
                        <p class="card-text">${comment.content}</p>
                        <p class="text-muted small">${new Date(comment.timestamp).toLocaleString()}</p>
                    </div>
                </div>`;
            commentsDiv.innerHTML += commentHTML;
        }

        document.getElementById("commentForm").addEventListener("submit", function (e) {
            e.preventDefault();
            sendComment();
        });

        connect(); 

    </script>
</body>
</html>
